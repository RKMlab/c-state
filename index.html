<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>C-State v0.2</title>
  <!-- CSS links -->
  <link href="scripts/require/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="scripts/require/animate.min.css" rel="stylesheet">
  <link href="styles/main.css" rel="stylesheet">
  <link href="styles/modals.css" rel="stylesheet">
</head>

<body>

  <div class="container-fluid">

    <div style="position: absolute; top: 0; left: 0;">
      <a href="http://ccmb.res.in/rakeshmishra/c-state/"> <img style="margin-left: 5px; margin-top: 5px;" width="80%" src="images/c-state_logo.png" alt="C-State Logo">
    </div>

    <div style="position: absolute; top: 0; right: 0; ">
      <a href="http://ccmb.res.in/"> <img style="float: right; margin-right: 20px; margin-top: 5px;" src="images/ccmb_logo_new.png" alt="CSIR Logo">
    </div>

    <div class="panel-group" id="main">

      <div id="files" class="panel panel-default active" href="#files">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a href="#files">Files</a>
          </h4>
        </div>
        <div id="files-body" class="panel-collapse collapse in">

          <div class="panel-body" v-cloak id="main-file">
            <div class="row">
              <div class="container-fluid col-md-2"></div>
              <div class="container-fluid col-md-4">
                <div style="text-align:center; font-size: 18px; font-weight:bold">Choose a file below to begin</div>
                <p style="text-align:justify; margin: 5 20 5 20">This can be a list of gene identifiers that you are interested in, or it could be a previously downloaded
                  plot data of C-State</p>
              </div>
              <div class="container-fluid col-md-1" style="text-align: center; font-size: 20px; margin-top: 20px;">OR</div>
              <div class="container-fluid col-md-3">
                <button class="text-center btn btn-warning btn-file">LOAD EXAMPLE DATA</button>
                <span style="margin-left: 6px; display: inline-block; margin-top: 20px;">of
                <input type="number" size="1" min="1" max="6" style="margin-left: 6px; width:35px;text-align: right;"/>
                Cell Types</span><br>
              </div>
            </div><br>

            <div class="row">
              <div class="container-fluid col-md-11">
                <table style="margin: 20 10 20 20; width: 100%">
                  <col style="width: 15%">
                  <col style="width: 15%">
                  <col style="width: 15%">
                  <col style="width: 15%">
                  <col style="width: 15%">
                  <col style="width: 5%">
                  <col style="width: 10%">
                  <col style="width: 10%">
                  <tr>
                    <th>File Selected</th>
                    <th>Select File Type</th>
                    <th>Select Genome</th>
                    <th>Select Build</th>
                    <th>Select Identifier</th>
                    <th></th>
                    <th>Upstream Flank <br>(in KB)</th>
                    <th>Downstream Flank <br>(in KB)</th>
                  </tr>
                  <tr>
                    <td style="text-align:center">
                      <label class="text-center btn btn-primary btn-file">Choose File
                      <input type="file" style="display: none" @change="onFileUpload" name="file">
                    </label><br> {{ inputFile.name }} </td>
                    <td>
                      <select @change="onTypeSelect" class="form-control" v-model="typeSelected">
                      <option v-for="option in typeOptions" :value="option.value">
                        {{ option.name }}
                      </option>
                    </select>
                    </td>
                    <td>
                      <select @change="onGenomeSelect" :disabled="typeSelected === 'plotdata'" class="form-control" v-model="genomeSelected">
                      <option v-for="option in genomes.species">
                        {{ option.name }}
                      </option>
                    </select>
                    </td>
                    <td>
                      <select @change="onVersionSelect" :disabled="typeSelected === 'plotdata'" class="form-control" v-model="versionSelected">
                      <option v-for="option in versionOptions">
                        {{ option }}
                      </option>
                    </select>
                    </td>
                    <td>
                      <select @change="onIDSelect" :disabled="typeSelected === 'plotdata'" class="form-control" v-model="idSelected">
                      <option v-for="option in idOptions" :value="option.value">
                        {{ option.name }}
                      </option>
                    </select>
                      <td></td>
                    </td>
                    <td>
                      <input type="number" min="0" style="text-align:right" :disabled="typeSelected === 'plotdata'" class="form-control" v-model="flankUp">
                    </td>
                    <td>
                      <input type="number" min="0" style="text-align:right" :disabled="typeSelected === 'plotdata'" class="form-control" v-model="flankDown">
                    </td>
                  </tr>
                </table>
              </div>
            </div>

            <!--Main File Div Ends Here-->
          </div>

          <div class="panel-body" id="feature-files" v-cloak v-if="showDiv">
            <div class="row">
              <div class="container-fluid col-md-2 col-md-offset-1">
                <label :disabled="!showFeatureButton" class="text-center btn btn-default btn-file">Add Feature Files
                  <input :disabled="!showFeatureButton" @change="onFileUpload" type="file" style="display: none" name="files[]" multiple>
                </label><br>
              </div>
              <div class="container-fluid col-md-1">
                <button :disabled="inputFiles.length === 0" @click="inputFiles.splice(0)" type="button" class="btn btn-danger">Clear All Files</button>
                <br>
              </div>
              <div class="container-fluid col-md-1">
                <button :disabled="inputFiles.length === 0" @click="getFileData" type="button" class="btn btn-success">Process All Files</button>
                <br>
              </div>
              <div class="container-fluid col-md-2">
                <button type="button" class="btn btn-primary" :disabled="!showPlotButton" onclick="formatPlotScope()">
                  View Data
                </button>
              </div>
              <div class="container-fluid col-md-1">
                <button type="button" class="btn btn-primary" :disabled="!showDownloadButton" onclick="exportJSONtoFile()">
                  Download Plot Data
                </button>
              </div>
            </div>

            <div class="row"><br>
              <div v-if="inputFiles.length > 0" style="text-align: justify; margin-left: 2.5vw; font-weight: bold; font-size:14px">Feature Files Selected: {{ inputFiles.length }} </div>
              <table style="margin-top:20px; width:95%; margin-left: auto; margin-right: auto" class="table table-hover">
                <tr v-if="inputFiles.length > 0">
                  <th>File Name</th>
                  <th>Celltype Name</th>
                  <th>Feature Name</th>
                  <th>File Format</th>
                  <!--<th>Color</th>-->
                  <th></th>
                </tr>
                <tr is="filerow" :file="file" @add="addData" @remove="inputFiles.splice(index, 1)" :key="file.name" v-for="(file, index) in inputFiles">
                </tr>
              </table>
            </div>

            <!--Feature Files Div Ends Here-->
          </div>

          <!--Files Div Ends Here-->
        </div>
        <!--File Accordion Ends Here-->
      </div>


      <div id="view" class="panel panel-default viewClass" href="#view-body">
        <div class="panel-heading">
          <h4 class="panel-title">
            <a href="#view-body">View - Showing {{numFilteredGenes}} of {{genes.length}} genes</a>
            <!--<p style="text-align:center"> </p>-->
          </h4>
        </div>
        <div id="view-body" class="panel-collapse collapse">
          <div class="row">
            <div class="container-fluid" style="margin-left:10px; margin-right:10px;">
              <table style="width:100%; table-layout: fixed; margin-bottom: 0px;" class="table table-condensed">
                <!--<thead><tr style="display: block; position: relative">-->
                <th style="text-align: center" v-for="type in info.celltypes"> {{ type.name }}</th>
                <!--</tr></thead>-->
              </table>
            </div>
            <div class="container-fluid dragscroll" style="margin-left:10px; margin-right:10px; height: 85vh; overflow:auto" id='plotarea'>
              <table id="gene-table" style="width:100%;" class="table table-bordered table-condensed">
                <tr is="generow" :gene="gene" v-if="gene.show" v-for="gene in genes"></tr>
                <!--</tbody>-->
              </table>
            </div>
          </div>
        </div>
      </div>

      <!--Main Div Ends Here-->
    </div>

    <!--Gene modal div-->
    <div id='gene-modal' v-cloak>
      <transition name="gene-transition" enter-active-class="animated zoomIn" leave-active-class="animated zoomOut">
        <div class="modal-mask" v-if="this.showModal">
          <div class="modal-wrapper">
            <div class="modal-container">

              <div class="modal-header">
                <h3>
                  {{ gene.name }}
                </h3>
                <h4>{{ gene.geneinfo.chrom }}:{{ gene.geneinfo.txStart }}-{{gene.geneinfo.txEnd}}({{gene.geneinfo.strand}})</h4>
              </div>

              <div class="modal-body dragscroll" style="overflow: auto; width:inherit;">
                <table class="modaltable" style="margin: 0px; table-layout: fixed">
                  <tr is="modalpanel" :index="index-1" :gene="gene" v-for="index in numCellTypes">
                  </tr>
                </table>
              </div>

              <div class="modal-footer">
                <button class="btn btn-primary" onclick="events.$emit('reset_zoom')">Reset Zoom</button>
                <button class="btn btn-default" @click="closeModal()">Close</button>
              </div>

            </div>
          </div>
        </div>
      </transition>
    </div>

    <!--Common Mask for panels-->
    <div id="common-mask" class="modal-mask"></div>

    <!--Filter Modal Div-->
    <div id='filter-button'>
      <button onclick="showFilters()" type="button" title="Open Filters Panel" class="btn btn-block btn-lg btn-default glyphicon glyphicon-filter"></button>
    </div>
    <div id='filter-modal'>
      <div id='filter-mask' class="modal-wrapper animated slideInLeft" v-if="showFilterDiv">
        <div class="modal-container">

          <div class="modal-header">
            <h3 style="text-align: center">Filters Panel</h3>
          </div>

          <div class="modal-body" style="width:inherit;">
            <div class="row" style="text-align: center">
              <div style="border-right: 1px solid black; height: 70vh;" class="container-fluid col-md-3">
                <h4>Available Filters</h4>
                <h6>Click on a filter to add it</h6><br><br>
                <h5>Filter Genes By</h5>
                <ol style="padding: 0">
                  <button :disabled="!genesLoaded" style="width: 100%; margin-bottom: 5px" class="btn btn-default" v-for="(filter, index) in availableFilters"
                    @click="addFilter(index)">
                    {{ filter.name }}
                    <span class="badge" :style="{ backgroundColor: colors[index] }"> {{ _.filter(activeFilters, ['type', filter.type]).length }}</span>
                  </button>
                </ol>
              </div>

              <div class="container-fluid col-md-8 dragscroll" style="height: 70vh; overflow-y: auto">
                <h4>Active Filters</h4>
                <ul style="padding: 0">
                  <span :key="filter.type" v-for="(filter, index) in activeFilters">
                    <table style="width: 100%">
                      <tr>
                        <td style="width: 85%">
                          <component :style="{ borderColor: getColor(filter.type) }" :is="filter.type">
                          </component>
                        </td>
                        <td>
                          <button style="margin-top: 10px; margin-left: 0px;" class="btn btn-default glyphicon glyphicon-remove" @click="activeFilters.splice(index, 1)">
                          </button>
                        </td>
                      </tr>
                    </table>
                  </span>
                </ul>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-success" @click="applyFilters">Apply Filters</button>
            <button class="btn btn-primary" @click="clearFilters">Clear All Filters</button>
            <button class="btn btn-danger" onclick="hideFilterDiv()">Close</button>
          </div>

        </div>
      </div>
    </div>

    <!--Settings Modal Div-->
    <div id='settings-button'>
      <button onclick="showSettings()" type="button" title="Open Settings Panel" class="btn btn-block btn-lg btn-default glyphicon glyphicon-cog"></button>
    </div>
    <div id='settings-modal'>
      <div id='settings-body' class="modal-wrapper animated slideInLeft" v-if="showSettingsDiv">
        <div class="modal-container">

          <div class="modal-header">
            <h3 style="text-align: center">Settings Panel</h3>
          </div>

          <div class="modal-body" style="width:inherit;">
            <div class="row" style="text-align: center">

              <div class="col-md-4" style="border-right: 1px solid black; height: 70vh;">
                <ul class="nav nav-pills nav-stacked">
                  <li class="active"><a data-toggle="tab" href="#ui-settings">Interface</a></li>
                  <li><a data-toggle="tab" href="#mainpanel-settings">Main Panels</a></li>
                  <li><a data-toggle="tab" href="#genemodal-settings">Gene Modal</a></li>
                </ul>
              </div>

              <div class="col-md-8">
                <div class="tab-content">
                  <div id="ui-settings" class="tab-pane fade in active">
                    <h4>User Interface Settings</h4>
                  </div>
                  <div id="mainpanel-settings" class="tab-pane fade">
                    <h4>Main Panel Settings</h4>
                    <ul style="text-align: center; padding-left: 10%; padding-right: 20%">
                      <li>
                        <input type="checkbox" v-model="scope.settings.mainPanel.showExons">Show exons
                      </li>
                      <li>
                        <input type="checkbox" v-model="scope.settings.mainPanel.showNeighbors">Show neighboring genes
                      </li><br>
                      <li>
                        Gene Bar Height:
                        <input class="filter-input" style="text-align:right; width: 20%" v-model.number="scope.settings.mainPanel.geneBarHeight">pixels
                      </li>
                      <li>
                        Region Bar Height:
                        <input class="filter-input" style="text-align:right; width: 20%" v-model.number="scope.settings.mainPanel.regionBarHeight">pixels
                      </li>
                      <li>
                        Feature Bar Height:
                        <input class="filter-input" style="text-align:right; width: 20%" v-model.number="scope.settings.mainPanel.featureBarHeight">pixels
                      </li>
                      <li>
                        Neighbor Bar Height:
                        <input class="filter-input" style="text-align:right; width: 20%" v-model.number="scope.settings.mainPanel.neighborBarHeight">pixels
                      </li><br>
                      <li>
                        Gene Bar Color:
                        <input class="filter-input" type="color" v-model="scope.settings.mainPanel.geneBarColor">
                      </li>
                      <li>
                        Region Bar Color:
                        <input class="filter-input" type="color" v-model="scope.settings.mainPanel.regionBarColor">
                      </li>
                      <li>
                        Neighbor Bar Color:
                        <input class="filter-input" type="color" v-model="scope.settings.mainPanel.neighborBarColor">
                      </li>
                    </ul>
                  </div>
                  <div id="genemodal-settings" class="tab-pane fade">
                    <h4>Gene Modal Settings</h4>
                    <ul style="text-align: left">
                      <li>
                        <input type="checkbox" v-model="scope.settings.geneModal.showExons">Show exons
                      </li>
                      <li>
                        <input type="checkbox" v-model="scope.settings.geneModal.showNeighbors">Show neighboring genes
                      </li>
                      <li>
                        <input type="checkbox" v-model="scope.settings.geneModal.showIsoforms">Show Isoforms track
                      </li>
                    </ul>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-success" @click="applySettings">Apply Settings</button>
            <button class="btn btn-danger" onclick="hideSettingsDiv()">Close</button>
          </div>

        </div>
      </div>
    </div>

    <div id='spinner' v-if="loading">
      <div class="loading-overlay"></div>
      <clip-loader :loading="loading" :color="color" :size="size"></clip-loader>
    </div>

    <!--Body Container Close-->
  </div>

  <!--Vue Templates-->

  <!--template for input file row-->
  <template id='filerow-template'>
    <tr>
      <td style="text-align: justify"> {{ file.name }} </td>
      <td>
        <input class="form-control" :class="{ empty: !cellType.name }" v-model="cellType.name">
      </td>
      <td>
        <input class="form-control" :class="{ empty: !feature.name }" v-model="feature.name">
      </td>
      <td>
        <select class="form-control" :class="{ empty: !formatSelected }" v-model="formatSelected">
          <option v-for="option in formatOptions" :value="option.value">
            {{ option.name }}
          </option>
        </select>
      </td>
      <td>
        <button class="btn btn-default glyphicon glyphicon-remove" @click="$emit('remove')"></button>
      </td>
    </tr>
  </template>

  <!-- template for the gene row -->
  <template id='generow-template'>
    <tr>
      <td align="center" is="mainpanel" :index="index" :gene="gene" v-for="(item, index) in info.celltypes"></td>
    </tr>
  </template>

  <!--template for gene panel in main view-->
  <template id='mainpanel-template'>
    <td>
      <div>
        <a class="panel-header" :gene="gene" @click="openModal(gene)" style="font-weight: bold">{{ gene.name }}</a>
        <br>
      </div>
    </td>
  </template>

  <!--template for gene panel in modal view-->
  <template id='modalpanel-template'>
    <tr>
      <td style="font-weight: bold; width: 30px; text-align: right; word-wrap: break-word; padding-right: 20px"> {{ cellTypeName }}</td>
      <td>
        <div class="modal-panel-row">
        </div>
      </td>
    </tr>
  </template>

  <!--Filter templates-->

  <!--Name Filter template-->
  <template id='name-filter-template'>
    <div class="filter-component row">
      <h5><strong>Name Filter</strong></h5>
      <div>
        <select class="filter-input" v-model="hideGene">
          <option :value="{ boolean: false}">Show</option>
          <option :value="{ boolean: true}">Hide</option>
        </select> following gene(s):
        <input style="margin-top: 5px;" class="form-control" v-model="userInput">
      </div>
      <div class="row">
        <input type="checkbox" :disabled="matchBeginning" v-model="matchPartial"> Allow partial match
      </div>
      <div class="row">
        <input type="checkbox" :disabled="matchPartial" v-model="matchBeginning"> Match beginning only
      </div>
    </div>
  </template>

  <!--Size Filter Template-->
  <template id='size-filter-template'>
    <div class="filter-component row">
      <h5><strong>Gene Size Filter</strong></h5><br>
      <div>Show
        <select class="filter-input" v-model="locusSelected">
          <option v-for="option in loci" :value="option.value"> {{option.name}} </option>
        </select>
        <select class="filter-input" v-model="operatorSelected">
          <option v-for="option in operators" :value="option.value"> {{option.name}} </option>
        </select>
        <input style="text-align: right; width: 15%" class="filter-input" v-model.number="sizeCutOff">KB
      </div>
    </div>
  </template>

  <!--Counts Filter Template-->
  <template id='counts-filter-template'>
    <div class="filter-component">
      <h5><strong>Feature Counts Filter</strong></h5>

      <div class="container-fluid row">
        <div class="container-fluid col-md-6">Choose Celltype:<br>
          <select class="form-control" v-model="cellTypeSelected">
            <option v-for="option in celltypes" :value="option.value">
              {{ option.name }}
            </option>
          </select>
        </div>
        <div class="container-fluid col-md-6">Choose Feature:<br>
          <select class="form-control" v-model="featureSelected">
            <option v-for="option in features" :value="option.value">
              {{ option.name }}
            </option>
          </select>
        </div>
      </div><br>

      <div class="container-fluid row">
        <!--<div class="container-fluid col-md-8">-->
        <span>Features Count</span>
        <select class="filter-input" v-model="operatorSelected">
            <option v-for="option in operators" :value="option.value">
              {{ option.name }}
            </option>
          </select>
        <input class="filter-input" style="text-align:right; width: 20%" v-model.number="featureCount">
        <!--</div>-->
      </div><br>

      <div class="container-fluid row">
        <!--<div class="container-fluid col-md-3">-->
        <span>Distance from TSS (in KB)</span>
        <!--</div>-->
      </div>
      <div class="container-fluid row">
        <table style="width: 80%; margin: auto">
          <tr>
            <td>Upstream</td>
            <td>Downstream</td>
          </tr>
          <tr>
            <td>
              <input class="filter-input" style="text-align:right; width: 80%" v-model.number="upstreamLimit">
            </td>
            <td>
              <input class="filter-input" style="text-align:right; width: 80%" v-model.number="downstreamLimit">
            </td>
          </tr>
        </table>
      </div>
    </div>
  </template>

  <!--Overlaps filter-->
  <template id='overlap-filter-template'>
    <div class="filter-component row">
      <h5><strong>Overlaps Filter</strong></h5>

      <div class="container-fluid row">Choose Celltype:
        <!--<div class="container-fluid col-md-6">Choose Celltype:<br>-->
        <select class="form-control" style="width: 50%" v-model="cellTypeSelected">
          <option v-for="option in celltypes" :value="option.value">
            {{ option.name }}
          </option>
        </select>
      </div><br>
      <div class="container-fluid row">
        <table style="width: 90%; margin: auto">
          <tr>
            <td>First Feature</td>
            <td>Relation</td>
            <td>Second Feature</td>
          </tr>
          <tr>
            <td>
              <select class="filter-input" style="width: 90%" v-model="firstFeatureSelected">
                <option v-for="option in features" :value="option.value">
                  {{ option.name }}
                </option>
              </select>
            </td>
            <td>
              <select class="filter-input" style="width: 90%" v-model="relationSelected">
                <option v-for="option in relations" :value="option.value">
                  {{ option.name }}
                </option>
              </select>
            </td>
            <td>
              <select class="filter-input" style="width: 90%" v-model="secondFeatureSelected">
                <option v-for="option in features" :value="option.value">
                  {{ option.name }}
                </option>
              </select>
            </td>
          </tr>
        </table>
      </div><br>
      
      <div class="container-fluid row">
        <!--<div class="container-fluid col-md-3">-->
        <span>Distance between features (in KB)</span>
        <!--</div>-->
      </div>
      <div class="container-fluid row">
        <table style="width: 50%; margin: auto">
          <tr>
            <td>Min</td>
            <td>Max</td>
          </tr>
          <tr>
            <td>
              <input :disabled="relationSelected === 'overlap'" class="filter-input" style="text-align:right; width: 50%" v-model.number="minDistance">
            </td>
            <td>
              <input :disabled="relationSelected === 'overlap'" class="filter-input" style="text-align:right; width: 50%" v-model.number="maxDistance">
            </td>
          </tr>
        </table>
      </div><br>

      <div class="container-fluid row">
        <!--<div class="container-fluid col-md-3">-->
        <span>Distance of first feature from TSS (in KB)</span>
        <!--</div>-->
      </div>
      <div class="container-fluid row">
        <table style="width: 50%; margin: auto">
          <tr>
            <td>Upstream</td>
            <td>Downstream</td>
          </tr>
          <tr>
            <td>
              <input class="filter-input" style="text-align:right; width: 50%" v-model.number="upstreamLimit">
            </td>
            <td>
              <input class="filter-input" style="text-align:right; width: 50%" v-model.number="downstreamLimit">
            </td>
          </tr>
        </table>
      </div>
    </div>
  </template>


  <!-- JS Dependencies -->
  <script src="scripts/require/jquery-1.12.4.js"></script>
  <script src="scripts/require/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
  <script src="scripts/require/d3v4/d3.js"></script>
  <script src="scripts/require/vue_v2.js"></script>
  <script src="scripts/require/vue-spinner.min.js"></script>
  <script src="scripts/require/lodash.js"></script>
  <script src="scripts/require/dragscroll.js"></script>
  <script src="scripts/require/FileSaver.min.js"></script>
  <!-- My JS Files -->
  <script src="scripts/main.js"></script>
  <!--Vue components-->
  <script src="scripts/components/filerow.js"></script>
  <script src="scripts/components/generow.js"></script>
  <script src="scripts/components/mainpanel.js"></script>
  <script src="scripts/components/modalpanel.js"></script>
  <!--Vue based views-->
  <script src="scripts/views/files.js"></script>
  <script src="scripts/views/genemodal.js"></script>
  <script src="scripts/views/filtermodal.js"></script>
  <script src="scripts/views/settingsmodal.js"></script>
  <script src="scripts/parsers/bed.js"></script>
  <script>
    // Make the entire accordion header clickable
    $(".panel.panel-default").click(function (e) {
      let panel = $(this).find("div.panel-collapse");
      $(this).toggleClass("active");
      $(panel).toggleClass("in");
    });

    // Stop click event on accordion body
    $(".panel-collapse").click(function (e) {
    e.stopPropagation();
    });
  </script>
</body>

</html>